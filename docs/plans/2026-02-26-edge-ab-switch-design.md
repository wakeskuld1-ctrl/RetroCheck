# Edge A/B 交替抹除设计（方案A）

## 背景与目标
- **背景**：边缘侧使用 KV 存储（sled）承载日志与指令数据，写入高频且设备多为廉价 SD 卡。
- **目标**：通过 A/B 双实例交替抹除，避免写放大与文件碎片化；保证断电恢复后状态一致；不引入业务 Schema 解析。
- **非目标**：网络协议替换与 Hub 批处理策略本轮不处理。

## 设计原则
- **写入只落单槽**：任何时刻只允许一个活动槽位写入。
- **元数据独立**：HWM、state_seq、切换计数等必须独立于槽位数据。
- **断电可恢复**：切换流程可被中断并正确恢复。
- **物理抹除**：切换后对旧槽位执行全量清空并重建。

## 目录与实例布局
- **根目录结构**
  - `slot_0/`：数据槽 0（sled::Db）
  - `slot_1/`：数据槽 1（sled::Db）
  - `meta/`：元数据槽（sled::Db）
- **元数据关键字段**
  - `active_slot`：当前活动槽位（0/1）
  - `next_active_slot`：预告槽位（切换中间态）
  - `last_switch_at_ms`：上次切换时间
  - `write_count`：累计写入条数
  - `bytes_written`：累计写入字节数
  - `state_seq`：物理状态序号
  - `hwm`：高水位线

## 切换触发策略（组合策略）
- **条数阈值**：写入条数达到阈值触发切换
- **时间阈值**：距离上次切换超过阈值触发切换
- **空间阈值**：累计写入字节数达到阈值触发切换
- **触发语义**：任一阈值触发即切换

## 切换流程
1. **预告新槽位**：`meta` 写入 `next_active_slot`
2. **刷盘**：确保预告落盘
3. **切换活动槽位**：更新 `active_slot` 为新槽位并刷盘
4. **物理抹除旧槽位**：删除旧槽目录并重建 sled 实例
5. **计数归零**：清空 `write_count`、`bytes_written`，更新 `last_switch_at_ms`

## 断电恢复语义
- **存在 `next_active_slot` 但未更新 `active_slot`**  
  - 视为切换未完成，继续使用旧槽位，清理 `next_active_slot`
- **`active_slot` 已更新但旧槽未抹除**  
  - 启动时补做旧槽抹除，保持只写新槽位
- **元数据完整性**  
  - `state_seq` 与 `hwm` 位于 `meta`，不随槽位抹除

## 读写路径与前缀扫描
- **写入路径**：仅写入 `active_slot`
- **TTL / cmd / log 扫描**：只扫描 `active_slot`，确保顺序与隔离
- **HWM/状态校验**：依赖 `meta`，与槽位无关

## 错误处理策略
- **切换失败**：回退到旧槽位并保留 `active_slot` 不变
- **抹除失败**：保留新槽位写入不受影响，记录失败待重试

## 测试策略（计划）
- **切换触发**：条数/时间/空间任一阈值触发切换
- **断电恢复**：模拟 `next_active_slot`/`active_slot` 不一致场景
- **抹除幂等**：重复抹除旧槽位不影响新槽位
- **写入隔离**：切换后旧槽位不再写入

## 风险与规避
- **风险**：抹除操作耗时导致切换卡顿  
  - **规避**：切换后异步抹除，写入不阻塞
- **风险**：计数器错误导致频繁切换  
  - **规避**：阈值配置校验与最小间隔限制
